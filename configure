#!/bin/sh

##==============================================================================
##
## configuredir
## rootrelative
## root
##     Determine the root directory of the distribution (not necessarily the
##     same as the current directory, since configure can be run anywhere).
##
##==============================================================================

configuredir=`pwd`
rootrelative=`dirname $0`
cd $rootrelative
root=`pwd`
cd $configuredir


##==============================================================================
##
## Product, Version, and Bilddate information:
##
##==============================================================================

product="OMIScriptProvider"
fullproduct="OMI Provider for scripting languages for Linux"

# MI_MAJOR and other items are dependent on a rational version number
# As a result, if version file can't be found, consider it fatal and
# don't generate a bogus one

if [ -f ../omiscriptprovider.version ]; then
    . ../omiscriptprovider.version
fi

if [ -n "$OMISCRIPTPROVIDER_BUILDVERSION_MAJOR" -a -n "$OMISCRIPTPROVIDER_BUILDVERSION_MINOR" -a -n "$OMISCRIPTPROVIDER_BUILDVERSION_PATCH" -a -n "$OMISCRIPTPROVIDER_BUILDVERSION_BUILDNR" ]; then
    major=$OMISCRIPTPROVIDER_BUILDVERSION_MAJOR
    minor=$OMISCRIPTPROVIDER_BUILDVERSION_MINOR
    revision=$OMISCRIPTPROVIDER_BUILDVERSION_PATCH
    patch_level=$OMISCRIPTPROVIDER_BUILDVERSION_BUILDNR
else
    echo "*** UNABLE TO LOCATE FILE omiscriptprovider.version ***" >& 2
    exit 1
fi

version="$major.$minor.$revision"
version_with_release="$major.$minor.$revision-$patch_level"
date=`date`


##==============================================================================
##
## Get command line options that start with slash.
##
##==============================================================================

for opt
do

  arg=`expr "x$opt" : 'x[^=]*=\(.*\)'`

  case $opt in

    -h | --help)
      help=1
      ;;

    --outputdirname=*)
      outputdirname=$arg
      ;;


    *)
        echo "$0: unknown option:  $opt"
        exit 1
        ;;

  esac
done


##==============================================================================
##
## Print the help message
##
##==============================================================================

if [ "$help" = "1" ]; then

    cat<<EOF

Usage: ./configure [OPTIONS]
OVERVIEW:
This script configures OMIScriptProvider for building. Type the following commands.
    $ ./configure
    $ make
OPTIONS:
    -h, --help              Print this help message.
    --outputdirname         The name of the output directory where the binary
                            files are placed. This name must not contain
                            slashes.
EOF
    exit 0
fi


##==============================================================================
##
## Create output directories.
##
##==============================================================================

if [ -z "$outputdirname" ]; then
    outputdirname=output
fi

outputdir=$configuredir/$outputdirname

mkdir -p $outputdir
echo "created $outputdir"


##==============================================================================
##
## Create config.mak file
##
##==============================================================================

fn=$outputdir/config.mak

cat > $fn <<EOF
# CAUTION: This file was generated by 'configure' script.
CONFIG_PRODUCT=$product
CONFIG_FULLPRODUCT=$fullproduct
CONFIG_VERSION=$version
CONFIG_MAJOR=$major
CONFIG_MINOR=$minor
CONFIG_REVISION=$revision
CONFIG_OMI_SCRIPTPROVIDER_VERSION_BUILD=$patch_level
CONFIG_DATE=$date

CONFIG_MAK=1

OSP_OUTPUTDIR=$outputdir
OSP_OUTPUTDIRNAME=$outputdirname
EOF

echo "created $fn"
